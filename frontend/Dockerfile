# ===============================
# üß± 1Ô∏è‚É£ –°—Ç–∞–¥–∏—è —Å–±–æ—Ä–∫–∏ (Node)
# ===============================
FROM node:20 AS build

WORKDIR /app

# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–±–∏–ª—å–Ω—ã–π npm registry
RUN npm config set registry https://registry.npmjs.org

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ package-lock.json (—á—Ç–æ–±—ã –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—Å –∫–µ—à–æ–º)
RUN npm ci --legacy-peer-deps --no-audit --no-fund || npm install --legacy-peer-deps --no-audit --no-fund

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º Vite-–ø—Ä–æ–µ–∫—Ç
RUN npm run build


# ===============================
# üöÄ 2Ô∏è‚É£ –°—Ç–∞–¥–∏—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (Nginx)
# ===============================
FROM nginx:stable-alpine

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ nginx –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π
RUN rm -f /etc/nginx/conf.d/default.conf
COPY nginx/default.conf /etc/nginx/conf.d/default.conf

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Brotli –¥–ª—è —Å–∂–∞—Ç–∏—è
RUN apk add --no-cache brotli

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç–∞–¥–∏–∏
COPY --from=build /app/dist /usr/share/nginx/html

# –ü–æ—Ä—Ç 80 ‚Äî HTTP
EXPOSE 80

# –ó–∞–ø—É—Å–∫–∞–µ–º nginx
CMD ["nginx", "-g", "daemon off;"]
